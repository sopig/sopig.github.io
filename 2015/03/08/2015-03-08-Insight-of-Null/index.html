<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Null 和 nullptr · xiao</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">Home</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   Blog</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2015/03/08/2015-03-08-Insight-of-Null/" class="post-title-link">Null 和 nullptr</a></h2><div class="post-meta"><div class="post-time">Sunday, March 8th 2015</div></div><div class="post-content"><p>斗战胜佛传记。。。  </p>
<a id="more"></a>
<p>##NULL和nullptr</p>
<p>在Clang 6.0 的stddef.h文件中可以找到<code>NULL</code>和<code>nullptr</code>的声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#undef NULL</div><div class="line">#ifdef __cplusplus</div><div class="line">#  if !defined(__MINGW32__) &amp;&amp; !defined(_MSC_VER)</div><div class="line">#    define NULL __null</div><div class="line">#  else</div><div class="line">#    define NULL 0</div><div class="line">#  endif</div><div class="line">#else</div><div class="line">#  define NULL ((void*)0)</div><div class="line">#endif</div><div class="line"></div><div class="line">#ifdef __cplusplus</div><div class="line">#if defined(_MSC_EXTENSIONS) &amp;&amp; defined(_NATIVE_NULLPTR_SUPPORTED)</div><div class="line">namespace std &#123; typedef decltype(nullptr) nullptr_t; &#125;</div><div class="line">using ::std::nullptr_t;</div><div class="line">#endif</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>早在1972年，C语言诞生的初期，常数0带有常数及空指针的双重身分。 C使用preprocessor macro <code>NULL</code>表示空指针，让<code>NULL</code>及<code>0</code>分别代表空指针及常数0。 <code>NULL</code>可被定义为<code>((void*)0)</code>或是<code>0</code>。</p>
<p>C++并不采用C的规则，不允许将<code>void*</code>隐式转换为其他类型的指针。为了使代码<code>char* c = NULL;</code>能通过编译，<code>NULL</code>只能定义为<code>0</code>。这样的决定使得函数重载无法区分代码的语义：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">void foo(char *);</div><div class="line">void foo(int);</div></pre></td></tr></table></figure>
<p>C++建议<code>NULL</code>应当定义为<code>0</code>，所以<code>foo(NULL);</code>将会调用<code>foo(int)</code>，这并不是程序员想要的行为，也违反了代码的直观性。0的歧义在此处造成困扰。</p>
<p>C++11引入了新的关键字来代表空指针常数：<code>nullptr</code>，将空指针和整数0的概念拆开。 <code>nullptr</code>的类型为<code>nullptr_t</code>，能隐式转换为任何指针或是成员指针的类型，也能和它们进行相等或不等的比较。而<code>nullptr</code>不能隐式转换为整数，也不能和整数做比较。</p>
<p>为了向下兼容，<code>0</code>仍可代表空指针常数。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">char* pc = nullptr;     // OK</div><div class="line">int * pi = nullptr;     // OK</div><div class="line">int    i = nullptr;     // error</div><div class="line"> </div><div class="line">foo(pc);           // 呼叫foo(char *)</div></pre></td></tr></table></figure>
<p>PS：<code>__MINGW32__</code>是MinGW编译器的预定义宏。<code>_MSC_VER</code>是微软C/C++编译器——cl.exe 编译代码时预定义的一个宏。<code>_MSC_VER</code>的值表示cl的版本。需要针对cl特定版本编写代码时，也可以使用该宏进行条件编译。</p>
<p>##nil和Nil</p>
<p>###Objective-C</p>
<p><code>nil</code>定义为实例对象的空值(a null instance)<br><code>Nil</code>定义为类对象的空值(a null class)<br><code>nil</code>和<code>Nil</code>在objc.h和MacTypes.h文件中均有等价的声明：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#ifndef Nil</div><div class="line"># if __has_feature(cxx_nullptr)</div><div class="line">#   define Nil nullptr</div><div class="line"># else</div><div class="line">#   define Nil __DARWIN_NULL</div><div class="line"># endif</div><div class="line">#endif</div><div class="line"></div><div class="line">#ifndef nil</div><div class="line"># if __has_feature(cxx_nullptr)</div><div class="line">#   define nil nullptr</div><div class="line"># else</div><div class="line">#   define nil __DARWIN_NULL</div><div class="line"># endif</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>根据Clang 3.7 文档对<code>__has_feature</code>的描述: “<code>__has_feature</code> evaluates to 1 if the feature is both supported by Clang and standardized in the current language standard or 0 if not”，<code>__has_feature(cxx_nullptr)</code>是用来判断是否支持C++11中的<code>nullptr</code>特性的。在Objective-C中<code>nil</code>和<code>Nil</code>都是<code>__DARWIN_NULL</code>宏定义。按住CMD鼠标点击进入<code>_types.h</code>:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#ifdef __cplusplus</div><div class="line">#ifdef __GNUG__</div><div class="line">#define __DARWIN_NULL __null</div><div class="line">#else /* ! __GNUG__ */</div><div class="line">#ifdef __LP64__</div><div class="line">#define __DARWIN_NULL (0L)</div><div class="line">#else /* !__LP64__ */</div><div class="line">#define __DARWIN_NULL 0</div><div class="line">#endif /* __LP64__ */</div><div class="line">#endif /* __GNUG__ */</div><div class="line">#else /* ! __cplusplus */</div><div class="line">#define __DARWIN_NULL ((void *)0)</div><div class="line">#endif /* __cplusplus */</div></pre></td></tr></table></figure>
<p>因为Objective-C不是C++代码，所以倒数第二行<code>#define __DARWIN_NULL ((void *)0)</code>此时高亮，意味着最终<code>nil</code>和<code>Nil</code>本质都为<code>((void *)0)</code>  </p>
<p>PS：其实如果只看Objective-C中的<code>nil</code>和<code>Nil</code>定义不用这么麻烦的，只需查看Objective-C Runtime Reference中的”Constants-&gt;Null Values”即可。  </p>
<p>###Swift</p>
<p>Swift 1.2 目前只有<code>nil</code>而没有<code>Nil</code>。为了安全性Swift新增了<code>Optional</code>类型来作为一个容器。好比一个箱子里面可能装有某种类型的对象，也可能是空的(<code>nil</code>)。箱子也可以嵌套，也可以去掉，但这都基于安全的解析、绑定等。Swift 的nil和 Objective-C 中的nil并不一样。在 Objective-C 中，<code>nil</code>是一个指向不存在对象的指针。在 Swift 中，<code>nil</code>不是指针——它是一个确定的值，用来表示值缺失。任何类型的可选值都可以被设置为<code>nil</code>，不只是对象（object）类型。  </p>
<p>PS:有关Swift中的<code>Optional</code>类型的更多信息可以参考我的另一篇博文：<a href="http://yulingtianxia.com/blog/2014/06/17/optionals-and-optional-chaining-in-swift/#Nil_Coalescing_Operator" target="_blank" rel="external">Optionals and Optional Chaining in Swift</a>  </p>
<p>PS：曾几何时，Swift的<code>nil</code>还不是字面量，而是<code>NilType</code>类型的唯一实例。但这一切都是历史了。  </p>
<p>##NSNull<br><code>NSNull</code>在NSNull.h中的定义：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@interface NSNull : NSObject &lt;NSCopying, NSSecureCoding&gt;</div><div class="line"></div><div class="line">+ (NSNull *)null;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>NSNull</code>是个单例，只有一个方法<code>null</code>，也用来表示空值。但它出现在一些<code>nil</code>无法胜任的场景来替代<code>nil</code>来表示空值。比如<code>NSArray</code>和<code>NSDictionary</code>中<code>nil</code>代表数组或字典的末尾(即使<code>nil</code>不出现在末尾，也会将其切断，<code>nil</code>后面的值会丢失)，此时只能用NSNull对象来表示空值：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">NSNull *nullValue = [NSNull null];</div><div class="line">NSArray *arrayWithNull = @[nullValue];</div><div class="line">NSLog(@&quot;arrayWithNull: %@&quot;, arrayWithNull);</div><div class="line">// Output: &quot;arrayWithNull: (&lt;null&gt;)&quot;</div></pre></td></tr></table></figure>
<p>虽然<code>NSNull</code>语义上等同于<code>nil</code>，但却并不完全等于<code>nil</code>：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">id aValue = [arrayWithNull objectAtIndex:0];</div><div class="line">if (aValue == nil) &#123;</div><div class="line">    NSLog(@&quot;equals nil&quot;);</div><div class="line">&#125;</div><div class="line">else if (aValue == [NSNull null]) &#123;</div><div class="line">    NSLog(@&quot;equals NSNull instance&quot;);</div><div class="line">    if ([aValue isEqual:nil]) &#123;</div><div class="line">        NSLog(@&quot;isEqual:nil&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">// Output: &quot;equals NSNull instance&quot;</div></pre></td></tr></table></figure>
<p>##参考</p>
<ul>
<li><a href="http://zh.wikipedia.org/wiki/C%2B%2B11#.E9.80.9A.E7.94.A8.E6.99.BA.E8.83.BD.E6.8C.87.E9.87.9D" target="_blank" rel="external">维基百科C++11</a></li>
<li><a href="http://clang.llvm.org/docs/LanguageExtensions.html#langext-has-feature-back-compat" target="_blank" rel="external">Clang 3.7 documentation</a></li>
</ul>
</div></article><div class="pagination"><a href="/2015/04/06/2015-04-06-Communication-between-your-App-and-Extensions/" class="pagination-prev">PREV</a><a href="/2015/03/06/代码结构/" class="pagination-next">NEXT</a></div><div class="comments"></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARC/">ARC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/App-Extensions/">App Extensions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AppGroups/">AppGroups</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CocoaPods/">CocoaPods</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/24/一首小诗/">1024,一首小诗</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/终有一天/">终有一天.md</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/樱花樱花想见你/">樱花樱花想见你</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/06/工具本/">小tips汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/02/CI搭建和脚本自动化/">CI搭建和脚本自动化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/01/又要春节了啊/">又要春节了啊</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/写给PM的iOS消息推送/">写给PM的iOS消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/19/gitlab和sourcetree的使用/">gitlab和sourcetree的使用</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2017 <a href="/">sopig</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>