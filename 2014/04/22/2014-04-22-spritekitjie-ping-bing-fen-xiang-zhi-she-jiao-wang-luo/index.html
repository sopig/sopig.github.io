<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> SpriteKit截屏并分享至社交网络 · xiao</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">Home</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   Blog</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2014/04/22/2014-04-22-spritekitjie-ping-bing-fen-xiang-zhi-she-jiao-wang-luo/" class="post-title-link">SpriteKit截屏并分享至社交网络</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/iOS/" class="post-tag-link">iOS</a></li><li class="post-tag-item"><a href="/tags/SpriteKit/" class="post-tag-link">SpriteKit</a></li><li class="post-tag-item"><a href="/tags/Social-Framework/" class="post-tag-link">Social Framework</a></li></ul><div class="post-time">Tuesday, April 22nd 2014</div></div><div class="post-content"><p>本文讲述在用<code>SpriteKit</code>制作iOS游戏的时候，如何让在用户在达到某种成就后分享自己的成就或分数，并附上一张游戏截屏，然后发到社交网络上<br><a id="more"></a></p>
<p>##SpriteKit截屏<br>传统的截屏方法是用UIView的layer来读取渲染上下文，生成图片  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">UIGraphicsBeginImageContext</span>(<span class="keyword">self</span>.view.frame.size); <span class="comment">//currentView 当前的view</span></div><div class="line">[<span class="keyword">self</span>.view.layer renderInContext:<span class="built_in">UIGraphicsGetCurrentContext</span>()];</div><div class="line"><span class="built_in">UIImage</span> *viewImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</div><div class="line"><span class="built_in">UIGraphicsEndImageContext</span>();</div></pre></td></tr></table></figure>
<p>viewImage就是获取的截图，如果要将图片存入相册，只需在后面调用  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UIImageWriteToSavedPhotosAlbum(viewImage,nil,nil,nil);</div></pre></td></tr></table></figure>
<p>而这一切都是基于<code>UIKit</code>的，在<code>SpriteKit</code>中，上面的方法是实效的，截屏的效果就是一张白色图片<br>但在苹果的官方文档中，明确提到了<code>SKTexture</code>的作用，最后一条是说可以将节点树渲染成纹理，可以应用于对游戏截屏。苹果还告诉了我们<code>SKView</code>的一个方法：<code>textureFromNode:</code>，该方法将以node包含的内容渲染成一个纹理，但是如何将<code>SKTexture</code>转换为<code>UIView</code>呢？我在workoverflow的一个<a href="http://stackoverflow.com/questions/21061248/uiimage-from-sktexture" target="_blank" rel="external">提问</a>中找到了答案：  </p>
<p>###方法一：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (UIImage*) imageWithView:(UIView *)view</div><div class="line">&#123;</div><div class="line">    UIGraphicsBeginImageContextWithOptions(view.bounds.size, view.opaque, 0.0);</div><div class="line"></div><div class="line">    [view drawViewHierarchyInRect:view.bounds afterScreenUpdates:YES];</div><div class="line"></div><div class="line">    UIImage * img = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">    UIGraphicsEndImageContext();</div><div class="line"></div><div class="line">    return img;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (UIImage*) imageFromNode:(SKNode*)node</div><div class="line">&#123;</div><div class="line">    SKTexture*      tex     = [self.scene.view textureFromNode:node];</div><div class="line">    SKView*         view    = [[SKView alloc]initWithFrame:CGRectMake(0, 0, tex.size.width, tex.size.height)];</div><div class="line">    SKScene*        scene   = [SKScene sceneWithSize:tex.size];</div><div class="line">    SKSpriteNode*   sprite  = [SKSpriteNode spriteNodeWithTexture:tex];</div><div class="line">    sprite.position = CGPointMake( CGRectGetMidX(view.frame), CGRectGetMidY(view.frame) );</div><div class="line">    [scene addChild:sprite];</div><div class="line">    [view presentScene:scene];</div><div class="line"></div><div class="line">    return [self imageWithView:view];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>get the SKTexture for your node using the current SKView</li>
<li>make another SKView that is just big enough for your texture</li>
<li>add a SKSpriteNode with the texture into your new scene, placing it in the middle</li>
<li>render the view into a graphics context</li>
</ol>
<p>###方法二:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">-(UIImage *)imageFromNode:(SKNode *)node &#123;</div><div class="line">    SKView *view = node.scene.view;</div><div class="line">    CGFloat scale = [UIScreen mainScreen].scale;</div><div class="line">    CGRect nodeFrame = [node calculateAccumulatedFrame];</div><div class="line">    </div><div class="line">    // render SKView into UIImage</div><div class="line">    UIGraphicsBeginImageContextWithOptions(view.bounds.size, YES, 0.0);</div><div class="line">    [view drawViewHierarchyInRect:view.bounds afterScreenUpdates:YES];</div><div class="line">    UIImage *sceneSnapshot = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">    UIGraphicsEndImageContext();</div><div class="line">    </div><div class="line">    // crop to the requested node (making sure to flip the y-coordinate)</div><div class="line">    CGFloat originY = sceneSnapshot.size.height*scale - nodeFrame.origin.y*scale - nodeFrame.size.height*scale;</div><div class="line">    CGRect cropRect = CGRectMake(nodeFrame.origin.x * scale, originY, nodeFrame.size.width*scale, nodeFrame.size.height*scale);</div><div class="line">    CGImageRef croppedSnapshot = CGImageCreateWithImageInRect(sceneSnapshot.CGImage, cropRect);</div><div class="line">    UIImage *nodeSnapshot = [UIImage imageWithCGImage:croppedSnapshot];</div><div class="line">    CGImageRelease(croppedSnapshot);</div><div class="line">    </div><div class="line">    return nodeSnapshot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>以上两个方法亲测好使！</strong></p>
<p>##使用Social.Framework分享游戏战绩<br>因为比较懒不想在各种第三方社交网站申请APP注册然后使用SDK等，有点复杂，所以暂时用了苹果自带的Social.Framework  </p>
<p>首先推荐一个比较好的<a href="https://github.com/yulingtianxia/ios6ShareDemo.git" target="_blank" rel="external">Demo</a>，代码很容易读，容易上手  </p>
<p>首先到target，Build Phases-&gt;link binary with libraries，添加social.framework，然后在要使用这个framework的文件头添加<code>@import Social;</code>  </p>
<p>记得要到iphone或者simulator里设置好对应社交网络的账号，填上用户名密码登录上，不然找不到account，不能post。如果找不到新浪微博，把系统语言调到中文。如果没有预先设置好账号，social.framework在真机和simulator上表现会不同。  </p>
<p>###使用UIActivityViewController<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//某个SKScene中添加的代码</div><div class="line">		sharingImage = [self imageFromNode:self];//获取截屏图片</div><div class="line">        NSArray *activityItems;</div><div class="line">        if (sharingImage != nil) &#123;</div><div class="line">            activityItems = @[sharingText, sharingImage];</div><div class="line">        &#125; else &#123;</div><div class="line">            activityItems = @[sharingText];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        UIActivityViewController *activityController =</div><div class="line">        [[UIActivityViewController alloc] initWithActivityItems:activityItems</div><div class="line">                                          applicationActivities:nil];</div><div class="line">        </div><div class="line">        [(UIViewController *)[self.view nextResponder] presentViewController:activityController</div><div class="line">                           animated:YES completion:nil];</div></pre></td></tr></table></figure></p>
<p><code>[self.view nextResponder]</code>的作用是获取当前<code>SKScene</code>的<code>UIViewController</code>  </p>
<p>如果想系统的学一下<code>UIActivityViewController</code>，建立看看这篇翻译自<a href="http://nshipster.com/uiactivityviewcontroller/" target="_blank" rel="external">Mattt Thompson</a>的<a href="https://github.com/nixzhu/dev-blog/blob/master/2014-04-22-ui-activity-viewcontroller.md" target="_blank" rel="external">博文</a>  </p>
<p>###使用SLComposeViewController<br>这个就相当于上面里介绍的单个分享service<br>目前支持的平台有以下这些：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SOCIAL_EXTERN NSString *const SLServiceTypeTwitter NS_AVAILABLE(10_8, 6_0);</div><div class="line">SOCIAL_EXTERN NSString *const SLServiceTypeFacebook NS_AVAILABLE(10_8, 6_0);</div><div class="line">SOCIAL_EXTERN NSString *const SLServiceTypeSinaWeibo NS_AVAILABLE(10_8, 6_0);</div><div class="line">SOCIAL_EXTERN NSString *const SLServiceTypeTencentWeibo NS_AVAILABLE(10_9, 7_0);</div><div class="line">SOCIAL_EXTERN NSString *const SLServiceTypeLinkedIn NS_AVAILABLE(10_9, NA);</div></pre></td></tr></table></figure>
<p>先声明一个<code>SLComposeViewController *slComposerSheet;</code>，然后在需要添加分享逻辑的地方加入下面代码：(依然以微博为例子)  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[slComposerSheet setCompletionHandler:^(SLComposeViewControllerResult result) &#123;</div><div class="line">       NSLog(@&quot;start completion block&quot;);</div><div class="line">       NSString *output;</div><div class="line">       switch (result) &#123;</div><div class="line">           case SLComposeViewControllerResultCancelled:</div><div class="line">               output = @&quot;Action Cancelled&quot;;</div><div class="line">               break;</div><div class="line">           case SLComposeViewControllerResultDone:</div><div class="line">               output = @&quot;Post Successfull&quot;;</div><div class="line">               break;</div><div class="line">           default:</div><div class="line">               break;</div><div class="line">       &#125;</div><div class="line">       if (result != SLComposeViewControllerResultCancelled)</div><div class="line">       &#123;</div><div class="line">           UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;Weibo Message&quot; message:output delegate:nil cancelButtonTitle:@&quot;Ok&quot; otherButtonTitles:nil];</div><div class="line">           [alert show];</div><div class="line">       &#125;</div><div class="line">   &#125;];</div><div class="line">   </div><div class="line">   if([SLComposeViewController isAvailableForServiceType:SLServiceTypeSinaWeibo])</div><div class="line">   &#123;</div><div class="line">       slComposerSheet = [SLComposeViewController composeViewControllerForServiceType:SLServiceTypeSinaWeibo];</div><div class="line">       [slComposerSheet setInitialText:self.sharingText];</div><div class="line">       [slComposerSheet addImage:self.sharingImage];</div><div class="line">       [slComposerSheet addURL:[NSURL URLWithString:@&quot;http://www.weibo.com/&quot;]];</div><div class="line">       [self presentViewController:slComposerSheet animated:YES completion:nil];</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这种方法我没试过，代码是照抄自前面提到的<a href="https://github.com/yulingtianxia/ios6ShareDemo.git" target="_blank" rel="external">Demo</a>里</p>
</div></article><div class="pagination"><a href="/2014/04/24/2014-04-24-ios7zi-ti-hui-zong/" class="pagination-prev">PREV</a><a href="/2014/04/17/2014-04-17-han-shu-zhi-zhen-yu-zhi-zhen-han-shu/" class="pagination-next">NEXT</a></div><div class="comments"></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARC/">ARC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/App-Extensions/">App Extensions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AppGroups/">AppGroups</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CocoaPods/">CocoaPods</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/24/一首小诗/">1024,一首小诗</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/终有一天/">终有一天.md</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/樱花樱花想见你/">樱花樱花想见你</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/06/工具本/">小tips汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/02/CI搭建和脚本自动化/">CI搭建和脚本自动化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/01/又要春节了啊/">又要春节了啊</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/写给PM的iOS消息推送/">写给PM的iOS消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/19/gitlab和sourcetree的使用/">gitlab和sourcetree的使用</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2017 <a href="/">sopig</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?38155daa8b79fb3a5cad11d825228868";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>